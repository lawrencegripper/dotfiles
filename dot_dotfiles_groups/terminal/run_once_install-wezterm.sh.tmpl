#!/bin/bash

{{ template "skip-unless-codespace.tmpl" . }}

set -e 

# Get OS information
. /etc/os-release

# Check if OS is Debian or Ubuntu
if [[ "$ID" != "debian" && "$ID" != "ubuntu" ]]; then
    echo "Unsupported OS: $ID"
    exit 0
fi

# Get latest release info from GitHub API (follow redirects)
LATEST_RELEASE=$(curl -sL https://api.github.com/repos/wezterm/wezterm/releases/latest)

# Extract the download URL for the appropriate .deb file
if [[ "$ID" == "ubuntu" ]]; then
    DEB_URL=$(echo "$LATEST_RELEASE" | grep -oP '"browser_download_url":\s*"\K[^"]*Ubuntu[^"]*\.deb' | grep -v 'arm64' | grep $VERSION_ID | head -1)
elif [[ "$ID" == "debian" ]]; then
    DEB_URL=$(echo "$LATEST_RELEASE" | grep -oP '"browser_download_url":\s*"\K[^"]*Debian[^"]*\.deb' | grep -v 'arm64' | grep Debian$VERSION_ID | head -1)
else
    echo "Unsupported codespaces container $ID $VERSION_ID. Skipping"
    exit 0
fi

echo $DEB_URL

if [[ -z "$DEB_URL" ]]; then
    echo "Could not find appropriate .deb file for $ID"
    exit 1
fi

# Download and install the .deb file
DEB_FILE=$(basename "$DEB_URL")
wget -q "$DEB_URL" -O "$DEB_FILE"
sudo apt install -y "./$DEB_FILE"
rm "$DEB_FILE"