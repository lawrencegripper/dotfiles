#!/bin/bash

NAME=$1
echo "Opening codespace $NAME"
# Copy auth details for atuin

gh cs cp --codespace $NAME -e ~/.config/atuin_login 'remote:/workspaces/.atuin_login' &
gh cs cp --codespace $NAME -e ~/.dotfile_groups/codespaces/hosts 'remote:/etc/hosts' &

cp ~/.config/wezterm/codespace_template.lua /tmp/codespace_$NAME.lua
sed -i "s/CS_NAME/${NAME}/g" /tmp/codespace_$NAME.lua

if gh codespace ssh --codespace $NAME -- "wezterm --version && env > /tmp/.bashenv"; then
    wezterm --config-file /tmp/codespace_$NAME.lua connect "${NAME}" &
else
    wezterm start -- bash -c "gh codespace ssh --codespace $NAME -- \
        -R 3123:100.110.255.124:80 \
        -R 8123:languagetool-api.unicorn-tailor.ts.net:8123" &
fi

# Start the codespace in vscode in background
gh cs code --codespace $NAME --insiders