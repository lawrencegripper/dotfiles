#!/bin/bash
set -e
export DEBIAN_FRONTEND=noninteractive

{{ template "skip-unless-local-debian.tmpl" . }}

# Only install if Zen Browser is not already installed
if [ ! -d /usr/local/zen ]; then
    # Download latest Zen Browser release
    LATEST_URL=$(wget -qO- https://api.github.com/repos/zen-browser/desktop/releases/latest | grep -oP '"browser_download_url": "\K[^"]*zen\.linux-x86_64\.tar\.xz')
    wget -q --show-progress "$LATEST_URL" -O /tmp/zen.linux-x86_64.tar.xz

    sudo tar -xf /tmp/zen.linux-x86_64.tar.xz -C /usr/local/

    sudo ln -sf /usr/local/zen/zen-bin /usr/bin/zen-bin

    # Clean up
    rm /tmp/zen.linux-x86_64.tar.xz
fi

# Setup as trusted 1password browser (only if not already present)
sudo mkdir -p /etc/1password
if [ ! -f /etc/1password/custom_allowed_browsers ] || ! grep -q "^zen-bin$" /etc/1password/custom_allowed_browsers; then
    echo "zen-bin" | sudo tee -a /etc/1password/custom_allowed_browsers
    sudo chown root:root /etc/1password/custom_allowed_browsers
    sudo chmod 755 /etc/1password/custom_allowed_browsers
fi